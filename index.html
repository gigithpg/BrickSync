<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrickSync</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <style>
    body { transition: background-color 0.3s, color 0.3s; }
    .sidebar-desktop { width: 250px; height: 100vh; position: fixed; top: 0; left: 0; z-index: 100; }
    .main-content { margin-left: 250px; transition: margin-left 0.3s; }
    @media (max-width: 991px) {
      .sidebar-desktop { display: none; }
      .main-content { margin-left: 0; }
      .quick-actions .btn { margin-bottom: 1rem; }
    }
    @media (max-width: 767px) {
      .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; }
      #customersTable, #salesTable, #paymentsTable, #transactionsTable, #balancesTable { min-width: 600px; }
      #salesTable { min-width: 1000px; }
      #paymentsTable { min-width: 800px; }
      #transactionsTable { min-width: 1100px; }
      th, td { white-space: nowrap; padding: 8px; font-size: 0.9rem; }
      thead th { position: sticky; top: 0; background-color: var(--bs-table-bg, #fff); z-index: 1; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); }
      [data-bs-theme="dark"] thead th { background-color: var(--bs-dark); }
      .action-group { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem; align-items: center; }
      .action-group .btn { width: 100%; max-width: 200px; font-size: 0.9rem; padding: 0.5rem; }
      .action-group .input-group { width: 100%; max-width: 250px; }
      .action-group .form-control, .action-group .form-select { font-size: 0.9rem; padding: 0.5rem; }
      .toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1050; width: 90%; max-width: 300px; }
    }
    @media (min-width: 768px) {
      .action-group { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem; align-items: flex-start; }
      .action-group .btn { width: auto; padding: 0.75rem 1.5rem; }
      .action-group .input-group { width: auto; max-width: 300px; }
    }
    .flatpickr-input { background-color: inherit; color: inherit; }
    .currency-input::before { content: 'â‚¹'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); }
    .currency-input input { padding-left: 25px; }
    .nav-link { cursor: pointer; padding: 12px 16px; }
    .nav-item { border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
    [data-bs-theme="dark"] .nav-item { border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .nav-item:nth-child(odd) { background-color: rgba(0, 0, 0, 0.02); }
    [data-bs-theme="dark"] .nav-item:nth-child(odd) { background-color: rgba(255, 255, 255, 0.02); }
    .nav-link:hover { background: linear-gradient(to right, rgba(0, 123, 255, 0.3), transparent); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: background 0.3s, box-shadow 0.3s; }
    [data-bs-theme="dark"] .nav-link:hover { background: linear-gradient(to right, rgba(0, 123, 255, 0.4), transparent); box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1); }
    .nav-link.active { font-weight: bold; background: linear-gradient(to right, rgba(0, 123, 255, 0.2), transparent); }
    .nav-link i { margin-right: 8px; }
    .nav-link.dashboard i { color: #17a2b8; }
    .nav-link.customers i { color: #007bff; }
    .nav-link.sales i { color: #28a745; }
    .nav-link.payments i { color: #6f42c1; }
    .nav-link.transactions i { color: #fd7e14; }
    .nav-link.balances i { color: #dc3545; }
    [data-bs-theme="dark"] .nav-link.dashboard i { color: #66c4d6; }
    [data-bs-theme="dark"] .nav-link.customers i { color: #66b0ff; }
    [data-bs-theme="dark"] .nav-link.sales i { color: #66d47e; }
    [data-bs-theme="dark"] .nav-link.payments i { color: #a98eda; }
    [data-bs-theme="dark"] .nav-link.transactions i { color: #ff9f66; }
    [data-bs-theme="dark"] .nav-link.balances i { color: #ff7777; }
    .required::after { content: '*'; color: #dc3545; margin-left: 4px; }
    .form-control-lg, .form-select-lg { font-size: 1.1rem; }
    .payment-method-option.cash { color: #28a745; }
    .payment-method-option.upi { color: #007bff; }
    .payment-method-option.bank { color: #6f42c1; }
    .payment-method-option.cheque { color: #fd7e14; }
    .payment-method-option.others { color: #6c757d; }
    .metric-card { transition: transform 0.2s; }
    .metric-card:hover { transform: translateY(-5px); }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
    .table { opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
    .table.loaded { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body data-bs-theme="light">
  <div class="toast-container">
    <div id="successToast" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body">
        <i class="bi bi-check-circle me-2"></i>
        <span id="toastMessage">Operation successful!</span>
      </div>
    </div>
  </div>
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">BrickSync</a>
      <button class="btn btn-outline-secondary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
        <i class="bi bi-list"></i>
      </button>
      <div class="navbar-nav ms-auto">
        <button id="theme-toggle" class="btn btn-outline-secondary">
          <i class="bi bi-sun-fill"></i>
        </button>
      </div>
    </div>
  </nav>
  <div class="sidebar-desktop bg-body-tertiary d-none d-lg-block">
    <div class="p-3">
      <h5>BrickSync</h5>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active dashboard" href="#dashboard" data-tab="dashboard"><i class="bi bi-house"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link customers" href="#customers" data-tab="customers"><i class="bi bi-person"></i>Customers</a></li>
        <li class="nav-item"><a class="nav-link sales" href="#sales" data-tab="sales"><i class="bi bi-cart"></i>Sales</a></li>
        <li class="nav-item"><a class="nav-link payments" href="#payments" data-tab="payments"><i class="bi bi-wallet2"></i>Payments</a></li>
        <li class="nav-item"><a class="nav-link transactions" href="#transactions" data-tab="transactions"><i class="bi bi-list-ul"></i>Transactions</a></li>
        <li class="nav-item"><a class="nav-link balances" href="#balances" data-tab="balances"><i class="bi bi-bar-chart"></i>Balances</a></li>
      </ul>
    </div>
  </div>
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="sidebarLabel">BrickSync</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active dashboard" href="#dashboard" data-tab="dashboard"><i class="bi bi-house"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link customers" href="#customers" data-tab="customers"><i class="bi bi-person"></i>Customers</a></li>
        <li class="nav-item"><a class="nav-link sales" href="#sales" data-tab="sales"><i class="bi bi-cart"></i>Sales</a></li>
        <li class="nav-item"><a class="nav-link payments" href="#payments" data-tab="payments"><i class="bi bi-wallet2"></i>Payments</a></li>
        <li class="nav-item"><a class="nav-link transactions" href="#transactions" data-tab="transactions"><i class="bi bi-list-ul"></i>Transactions</a></li>
        <li class="nav-item"><a class="nav-link balances" href="#balances" data-tab="balances"><i class="bi bi-bar-chart"></i>Balances</a></li>
      </ul>
    </div>
  </div>
  <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="customerModalLabel">Add Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="customerName" class="form-label required">Name</label>
              <input type="text" class="form-control form-control-lg" id="customerName" placeholder="Customer name" required>
            </div>
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="keepCustomerOpen">
                <label class="form-check-label" for="keepCustomerOpen">Keep form open</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="resetCustomerForm()">Reset</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitCustomerBtn" onclick="addCustomer()">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Submit
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="salesModal" tabindex="-1" aria-labelledby="salesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="salesModalLabel">Record Sales</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="saleDate" class="form-label required">Date</label>
              <input type="text" class="form-control form-control-lg flatpickr" id="saleDate" required>
            </div>
            <div class="col-md-4">
              <label for="saleCustomer" class="form-label required">Customer</label>
              <select class="form-select form-select-lg" id="saleCustomer" required>
                <option value="">Select Customer</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="saleQuantity" class="form-label required">Quantity</label>
              <input type="number" class="form-control form-control-lg" id="saleQuantity" min="0" step="0.01" required>
            </div>
            <div class="col-md-12">
              <div class="card mt-2">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label for="saleRate" class="form-label required">Rate</label>
                      <div class="position-relative currency-input">
                        <input type="number" class="form-control form-control-lg" id="saleRate" min="0" step="0.01" placeholder="0.00" required>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <label for="saleVehicleRent" class="form-label">Vehicle Rent</label>
                      <div class="position-relative currency-input">
                        <input type="number" class="form-control form-control-lg" id="saleVehicleRent" min="0" step="0.01" value="0" placeholder="0.00">
                      </div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label required">Amount</label>
                      <p class="form-control-static fs-5" id="saleAmountDisplay">â‚¹0.00</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <label for="salePaymentMethod" class="form-label">Payment Method</label>
              <select class="form-select form-select-lg" id="salePaymentMethod">
                <option value="">Select Method</option>
                <option value="Cash" class="payment-method-option cash">Cash</option>
                <option value="UPI" class="payment-method-option upi">UPI</option>
                <option value="Bank Transfer" class="payment-method-option bank">Bank Transfer</option>
                <option value="Cheque" class="payment-method-option cheque">Cheque</option>
                <option value="Others" class="payment-method-option others">Others</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="salePaymentReceived" class="form-label">Payment Received</label>
              <div class="position-relative currency-input">
                <input type="number" class="form-control form-control-lg" id="salePaymentReceived" min="0" step="0.01" value="0" placeholder="0.00" disabled>
              </div>
            </div>
            <div class="col-md-4">
              <label for="saleRemarks" class="form-label">Remarks</label>
              <input type="text" class="form-control form-control-lg" id="saleRemarks">
            </div>
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="keepSalesOpen">
                <label class="form-check-label" for="keepSalesOpen">Keep form open</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="resetSalesForm()">Reset</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitSaleBtn" onclick="addSale()">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Submit
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalLabel">Record Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="paymentDate" class="form-label required">Date</label>
              <input type="text" class="form-control form-control-lg flatpickr" id="paymentDate" required>
            </div>
            <div class="col-md-4">
              <label for="paymentCustomer" class="form-label required">Customer</label>
              <select class="form-select form-select-lg" id="paymentCustomer" required>
                <option value="">Select Customer</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="paymentMethod" class="form-label required">Payment Method</label>
              <select class="form-select form-select-lg" id="paymentMethod" required>
                <option value="">Select Method</option>
                <option value="Cash" class="payment-method-option cash">Cash</option>
                <option value="UPI" class="payment-method-option upi">UPI</option>
                <option value="Bank Transfer" class="payment-method-option bank">Bank Transfer</option>
                <option value="Cheque" class="payment-method-option cheque">Cheque</option>
                <option value="Others" class="payment-method-option others">Others</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="paymentReceived" class="form-label required">Payment Received</label>
              <div class="position-relative currency-input">
                <input type="number" class="form-control form-control-lg" id="paymentReceived" min="0" step="0.01" placeholder="0.00" disabled required>
              </div>
            </div>
            <div class="col-md-4">
              <label for="paymentRemarks" class="form-label">Remarks</label>
              <input type="text" class="form-control form-control-lg" id="paymentRemarks">
            </div>
            <div class="col-md-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="keepPaymentOpen">
                <label class="form-check-label" for="keepPaymentOpen">Keep form open</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="resetPaymentForm()">Reset</button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="submitPaymentBtn" onclick="addPayment()">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            Submit
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="main-content p-4">
    <div class="container-fluid">
      <div id="dashboard" class="tab-content active">
        <h4 class="mb-4">Dashboard</h4>
        <div class="row g-4 mb-4">
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="card-body">
                <h6 class="card-title">Total Customers</h6>
                <p class="card-text"><span class="badge bg-primary fs-5" id="dashTotalCustomers">0</span></p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="card-body">
                <h6 class="card-title">Total Sales</h6>
                <p class="card-text"><span class="badge bg-success fs-5" id="dashTotalSales">â‚¹0.00</span></p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="card-body">
                <h6 class="card-title">Total Payments</h6>
                <p class="card-text"><span class="badge bg-info fs-5" id="dashTotalPayments">â‚¹0.00</span></p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card metric-card">
              <div class="card-body">
                <h6 class="card-title">Pending Balance</h6>
                <p class="card-text"><span class="badge bg-warning fs-5" id="dashPendingBalance">â‚¹0.00</span></p>
              </div>
            </div>
          </div>
        </div>
        <div class="card mb-4">
          <div class="card-header">Sales vs Payments (Last 30 Days)</div>
          <div class="card-body">
            <canvas id="dashChart"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">Quick Actions</div>
          <div class="card-body quick-actions">
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#customerModal">Add Customer</button>
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#salesModal">Record Sales</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#paymentModal">Record Payment</button>
          </div>
        </div>
      </div>
      <div id="customers" class="tab-content d-none">
        <div class="mb-4">
          <div class="action-group">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal">Add Customer</button>
            <div class="input-group">
              <input type="text" class="form-control" id="customerSearch" placeholder="Search by name">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
            </div>
          </div>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Customers List
              <span class="badge bg-primary" id="totalCustomers">0</span>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="customersTable">
                  <thead>
                    <tr><th>Customer ID</th><th>Name</th><th>Actions</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="sales" class="tab-content d-none">
        <div class="mb-4">
          <div class="action-group">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#salesModal">Record Sales</button>
            <div class="input-group">
              <input type="text" class="form-control flatpickr-range" id="salesDateRange">
              <span class="input-group-text"><i class="bi bi-calendar"></i></span>
            </div>
          </div>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Sales List
              <span class="badge bg-primary" id="totalSalesAmount">â‚¹0.00</span>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="salesTable">
                  <thead>
                    <tr><th>Date</th><th>Sale ID</th><th>Customer</th><th>Quantity</th><th>Rate</th><th>Vehicle Rent</th><th>Amount</th><th>Payment Method</th><th>Payment Received</th><th>Remarks</th><th>Actions</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="payments" class="tab-content d-none">
        <div class="mb-4">
          <div class="action-group">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#paymentModal">Record Payment</button>
            <div class="input-group">
              <select class="form-select" id="paymentMethodFilter">
                <option value="">All Methods</option>
                <option value="Cash">Cash</option>
                <option value="UPI">UPI</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cheque">Cheque</option>
                <option value="Others">Others</option>
              </select>
            </div>
          </div>
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              Payments List
              <span class="badge bg-primary" id="totalPaymentsReceived">â‚¹0.00</span>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="paymentsTable">
                  <thead>
                    <tr><th>Date</th><th>Payment ID</th><th>Customer</th><th>Payment Method</th><th>Payment Received</th><th>Remarks</th><th>Actions</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="transactions" class="tab-content d-none">
        <div class="mb-4">
          <div class="action-group">
            <div class="input-group">
              <select class="form-select" id="transactionCustomerFilter">
                <option value="">All Customers</option>
              </select>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Transactions List</div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="transactionsTable">
                  <thead>
                    <tr>
                      <th>Type</th>
                      <th class="sortable" data-column="Date">Date <i class="bi bi-sort-down"></i></th>
                      <th>Transaction ID</th>
                      <th>Customer</th>
                      <th>Quantity</th>
                      <th>Rate</th>
                      <th>Vehicle Rent</th>
                      <th>Amount</th>
                      <th>Payment Method</th>
                      <th>Payment Received</th>
                      <th>Remarks</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="balances" class="tab-content d-none">
        <div class="card">
          <div class="card-header">Balances List</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped" id="balancesTable">
                <thead>
                  <tr><th>Customer</th><th>Total Sales</th><th>Total Payments</th><th>Pending Balance</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 });

    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-bs-theme', savedTheme);
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
      }
      document.querySelectorAll('.flatpickr-input').forEach(input => {
        input.classList.toggle('bg-dark', savedTheme === 'dark');
        input.classList.toggle('text-white', savedTheme === 'dark');
      });
      updateChartTheme();
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-bs-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-bs-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.innerHTML = newTheme === 'dark' ? '<i class="bi bi-sun-fill"></i>' : '<i class="bi bi-moon-fill"></i>';
      }
      document.querySelectorAll('.flatpickr-input').forEach(input => {
        input.classList.toggle('bg-dark', newTheme === 'dark');
        input.classList.toggle('text-white', newTheme === 'dark');
      });
      updateChartTheme();
    }

    function initializeFlatpickr() {
      flatpickr('.flatpickr', {
        dateFormat: 'd/m/Y',
        allowInput: true,
        clickOpens: true,
        parseDate: (datestr) => {
          const formats = [
            /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/, // dd/mm/yyyy or dd-mm-yyyy
            /^(\d{4})-(\d{1,2})-(\d{1,2})$/ // yyyy-mm-dd
          ];
          for (const regex of formats) {
            const match = datestr.match(regex);
            if (match) {
              let day, month, year;
              if (regex === formats[0]) {
                day = parseInt(match[1], 10);
                month = parseInt(match[2], 10) - 1;
                year = parseInt(match[3], 10);
              } else {
                year = parseInt(match[1], 10);
                month = parseInt(match[2], 10) - 1;
                day = parseInt(match[3], 10);
              }
              const date = new Date(year, month, day);
              return isNaN(date.getTime()) ? null : date;
            }
          }
          return null;
        },
        formatDate: (date) => {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        },
        onReady: () => {
          document.querySelectorAll('.flatpickr-input').forEach(input => {
            input.readOnly = false;
          });
        }
      });
      flatpickr('.flatpickr-range', {
        mode: 'range',
        dateFormat: 'd/m/Y',
        allowInput: true,
        clickOpens: true,
        parseDate: (datestr) => {
          const formats = [
            /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/,
            /^(\d{4})-(\d{1,2})-(\d{1,2})$/
          ];
          for (const regex of formats) {
            const match = datestr.match(regex);
            if (match) {
              let day, month, year;
              if (regex === formats[0]) {
                day = parseInt(match[1], 10);
                month = parseInt(match[2], 10) - 1;
                year = parseInt(match[3], 10);
              } else {
                year = parseInt(match[1], 10);
                month = parseInt(match[2], 10) - 1;
                day = parseInt(match[3], 10);
              }
              const date = new Date(year, month, day);
              return isNaN(date.getTime()) ? null : date;
            }
          }
          return null;
        },
        formatDate: (date) => {
          const day = String(date.getDate()).padStart(2, '0');
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        },
        onChange: (selectedDates) => {
          if (selectedDates.length === 2) {
            filterSalesTable(selectedDates[0], selectedDates[1]);
          }
        }
      });
      ['salesModal', 'paymentModal'].forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.addEventListener('shown.bs.modal', () => {
            flatpickr('.flatpickr', { dateFormat: 'd/m/Y', allowInput: true, clickOpens: true });
          });
        }
      });
    }

    function formatCurrencyInputs() {
      ['saleRate', 'saleVehicleRent', 'salePaymentReceived', 'paymentReceived'].forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('blur', () => {
            if (input.value) {
              const value = parseFloat(input.value);
              if (!isNaN(value)) {
                input.value = value.toFixed(2);
              }
            }
          });
        }
      });
    }

    function updateSaleAmount() {
      const quantity = parseFloat(document.getElementById('saleQuantity')?.value) || 0;
      const rate = parseFloat(document.getElementById('saleRate')?.value) || 0;
      const vehicleRent = parseFloat(document.getElementById('saleVehicleRent')?.value) || 0;
      const amount = (quantity * rate) + vehicleRent;
      const display = document.getElementById('saleAmountDisplay');
      if (display) {
        display.textContent = formatter.format(amount);
      }
      return amount;
    }

    function resetCustomerForm() {
      const modal = document.getElementById('customerModal');
      if (!modal) return;
      document.getElementById('customerName').value = '';
      document.getElementById('keepCustomerOpen').checked = false;
      const submitBtn = document.getElementById('submitCustomerBtn');
      if (submitBtn) {
        submitBtn.querySelector('.spinner-border')?.classList.add('d-none');
        submitBtn.innerHTML = 'Submit';
      }
      modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
    }

    function resetSalesForm() {
      const modal = document.getElementById('salesModal');
      if (!modal) return;
      document.querySelectorAll('#salesModal .form-control, #salesModal .form-select').forEach(input => input.value = '');
      document.getElementById('saleVehicleRent').value = '0';
      document.getElementById('salePaymentReceived').value = '0';
      document.getElementById('salePaymentReceived').disabled = true;
      document.getElementById('saleAmountDisplay').textContent = 'â‚¹0.00';
      document.getElementById('keepSalesOpen').checked = false;
      const submitBtn = document.getElementById('submitSaleBtn');
      if (submitBtn) {
        submitBtn.querySelector('.spinner-border')?.classList.add('d-none');
        submitBtn.innerHTML = 'Submit';
      }
      modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
      togglePaymentReceived('salePaymentMethod', 'salePaymentReceived');
    }

    function resetPaymentForm() {
      const modal = document.getElementById('paymentModal');
      if (!modal) return;
      document.querySelectorAll('#paymentModal .form-control, #paymentModal .form-select').forEach(input => input.value = '');
      document.getElementById('paymentReceived').value = '0';
      document.getElementById('paymentReceived').disabled = true;
      document.getElementById('keepPaymentOpen').checked = false;
      const submitBtn = document.getElementById('submitPaymentBtn');
      if (submitBtn) {
        submitBtn.querySelector('.spinner-border')?.classList.add('d-none');
        submitBtn.innerHTML = 'Submit';
      }
      modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
      togglePaymentReceived('paymentMethod', 'paymentReceived');
    }

    function showSuccessToast(message) {
      const toastEl = document.getElementById('successToast');
      if (toastEl) {
        document.getElementById('toastMessage').textContent = message;
        const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
        toast.show();
      }
    }

    let dashChart;
    function initializeChart(salesData, paymentsData) {
      const ctx = document.getElementById('dashChart')?.getContext('2d');
      if (!ctx) return;
      if (dashChart) {
        dashChart.destroy();
      }
      const today = new Date();
      const labels = Array.from({length: 30}, (_, i) => {
        const date = new Date(today);
        date.setDate(today.getDate() - (29 - i));
        return date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit' });
      });

      const salesByDate = labels.map(label => {
        const date = new Date(label.split('/').reverse().join('-'));
        return (salesData || []).reduce((sum, sale) => {
          let saleDate;
          try {
            const match = sale.Date.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (!match) return sum;
            saleDate = new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
          } catch (e) {
            console.error(`Invalid sale date: ${sale.Date}`);
            return sum;
          }
          return saleDate.toDateString() === date.toDateString() ? sum + (sale.Amount || 0) : sum;
        }, 0);
      });

      const paymentsByDate = labels.map(label => {
        const date = new Date(label.split('/').reverse().join('-'));
        return (paymentsData || []).reduce((sum, payment) => {
          let paymentDate;
          try {
            const match = payment.Date.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
            if (!match) return sum;
            paymentDate = new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
          } catch (e) {
            console.error(`Invalid payment date: ${payment.Date}`);
            return sum;
          }
          return paymentDate.toDateString() === date.toDateString() ? sum + (payment['Payment Received'] || 0) : sum;
        }, 0);
      });

      const theme = document.body.getAttribute('data-bs-theme');
      dashChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Sales',
              data: salesByDate,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.2)',
              fill: true
            },
            {
              label: 'Payments',
              data: paymentsByDate,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.2)',
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => formatter.format(value),
                color: theme === 'dark' ? '#ffffff' : '#000000'
              },
              grid: { color: theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
            },
            x: {
              ticks: { color: theme === 'dark' ? '#ffffff' : '#000000' },
              grid: { color: theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: theme === 'dark' ? '#ffffff' : '#333333'
              }
            }
          }
        }
      });
    }

    function updateChartTheme() {
      if (dashChart) {
        const theme = document.body.getAttribute('data-bs-theme');
        dashChart.options.scales.y.ticks.color = theme === 'dark' ? '#ffffff' : '#333333';
        dashChart.options.scales.x.ticks.color = theme === 'dark' ? '#ffffff' : '#333333';
        dashChart.options.scales.y.grid.color = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        dashChart.options.scales.x.grid.color = theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        dashChart.options.plugins.legend.labels.color = theme === 'dark' ? '#ffffff' : '#333333';
        dashChart.update();
      }
    }

    function setupTabNavigation() {
      document.querySelectorAll('[data-tab]').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();
          ['customerModal', 'salesModal', 'paymentModal'].forEach(modalId => {
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (modal) modal.hide();
          });
          resetCustomerForm();
          resetSalesForm();
          resetPaymentForm();
          document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('d-none'));
          document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
          const tabId = link.getAttribute('data-tab');
          const tabElement = document.getElementById(tabId);
          if (tabElement) {
            tabElement.classList.remove('d-none');
          }
          link.classList.add('active');
          const sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('sidebar'));
          if (sidebar) sidebar.hide();
          loadTableData(tabId);
        });
      });
    }

    let tableDataCache = {};
    function loadTableData(tab) {
      tableDataCache[tab] = null;
      if (tab === 'dashboard') {
        loadDashboardData();
        return;
      }
      const sheetName = tab.charAt(0).toUpperCase() + tab.slice(1);
      const tbody = document.getElementById(`${tab}Table`)?.querySelector('tbody');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="100" class="text-center">Loading...</td></tr>';
      }
      google.script.run
        .withSuccessHandler(data => {
          if (data && typeof data === 'object' && 'success' in data) {
            if (data.success) {
              tableDataCache[tab] = data.data;
              renderTable(tab, data.data);
              if (tab === 'transactions') {
                populateTransactionCustomerFilter(data.data);
              }
              updateBadges(tab, data.data);
            } else {
              console.error(`Error loading ${sheetName}: ${data.message || 'No response'}`);
              showSuccessToast(`Error loading ${sheetName}: ${data.message || 'Failed to load data'}`);
              if (tbody) {
                tbody.innerHTML = '<tr><td colspan="100" class="text-center">No data available</td></tr>';
              }
              if (data.message?.includes('was missing and has been recreated')) {
                setTimeout(() => loadTableData(tab), 2000);
              }
            }
          } else {
            console.error(`Invalid response for ${sheetName}:`, data);
            showSuccessToast(`Error loading ${sheetName}: Invalid server response`);
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="100" class="text-center">Error loading data</td></tr>';
            }
          }
        })
        .withFailureHandler(err => {
          console.error(`Error loading ${sheetName}:`, err);
          showSuccessToast(`Error loading ${sheetName}: ${err.message || 'Unknown error'}`);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="100" class="text-center">Error loading data</td></tr>';
          }
        })
        [`get${sheetName}`]();
    }

    function loadDashboardData() {
  tableDataCache['customers'] = null;
  tableDataCache['sales'] = null;
  tableDataCache['payments'] = null;
  tableDataCache['balances'] = null;
  Promise.all([
    new Promise(resolve => google.script.run
      .withSuccessHandler(data => resolve(data || { success: false, message: 'Invalid response', data: [] }))
      .withFailureHandler(err => resolve({ success: false, message: err.message || 'Unknown error', data: [] }))
      .getCustomers()),
    new Promise(resolve => google.script.run
      .withSuccessHandler(data => resolve(data || { success: false, message: 'Invalid response', data: [] }))
      .withFailureHandler(err => resolve({ success: false, message: err.message || 'Unknown error', data: [] }))
      .getSales()),
    new Promise(resolve => google.script.run
      .withSuccessHandler(data => resolve(data || { success: false, message: 'Invalid response', data: [] }))
      .withFailureHandler(err => resolve({ success: false, message: err.message || 'Unknown error', data: [] }))
      .getPayments()),
    new Promise(resolve => google.script.run
      .withSuccessHandler(data => resolve(data || { success: false, message: 'Invalid response', data: [] }))
      .withFailureHandler(err => resolve({ success: false, message: err.message || 'Unknown error', data: [] }))
      .getBalances())
  ]).then(([customers, sales, payments, balances]) => {
    tableDataCache['customers'] = customers.success ? customers.data : [];
    tableDataCache['sales'] = sales.success ? sales.data : [];
    tableDataCache['payments'] = payments.success ? payments.data : [];
    tableDataCache['balances'] = balances.success ? balances.data : [];
    document.getElementById('dashTotalCustomers').textContent = tableDataCache['customers'].length || 0;
    const totalSales = tableDataCache['sales'].reduce((sum, row) => sum + (row.Amount || 0), 0);
    document.getElementById('dashTotalSales').textContent = formatter.format(totalSales);
    const totalPayments = tableDataCache['payments'].reduce((sum, row) => sum + (row['Payment Received'] || 0), 0);
    document.getElementById('dashTotalPayments').textContent = formatter.format(totalPayments);
    const totalPending = tableDataCache['balances'].reduce((sum, row) => sum + (row.balance || 0), 0);
    document.getElementById('dashPendingBalance').textContent = formatter.format(totalPending);
    initializeChart(tableDataCache['sales'], tableDataCache['payments']);
    if (!customers.success || !sales.success || !payments.success || !balances.success) {
      console.error('Dashboard data load incomplete:', { customers, sales, payments, balances });
      showSuccessToast('Some dashboard data failed to load. Retrying...');
      setTimeout(() => loadDashboardData(), 2000);
    }
  }).catch(err => {
    console.error('Dashboard load error:', err);
    showSuccessToast(`Error loading dashboard: ${err.message || 'Unknown error'}`);
  });
}

    function renderTable(tab, data) {
  const tbody = document.getElementById(`${tab}Table`)?.querySelector('tbody');
  const table = document.getElementById(`${tab}Table`);
  if (!tbody || !table) return;
  const fragment = document.createDocumentFragment();
  data.forEach(row => {
    const tr = document.createElement('tr');
    const columns = tab === 'transactions' ? [
      'Type', 'Date', 'Transaction ID', 'Customer', 'Quantity', 'Rate', 'Vehicle Rent', 'Amount', 'Payment Method', 'Payment Received', 'Remarks'
    ] : tab === 'balances' ? [
      'Customer', 'Total Sales', 'Total Payments', 'Pending Balance'
    ] : tab === 'customers' ? [
      'Customer ID', 'Name'
    ] : tab === 'sales' ? [
      'Date', 'Sale ID', 'Customer', 'Quantity', 'Rate', 'Vehicle Rent', 'Amount', 'Payment Method', 'Payment Received', 'Remarks'
    ] : [
      'Date', 'Payment ID', 'Customer', 'Payment Method', 'Payment Received', 'Remarks'
    ];
    columns.forEach(key => {
      const td = document.createElement('td');
      let value = row[key];
      if (['Rate', 'Vehicle Rent', 'Amount', 'Payment Received', 'Total Sales', 'Total Payments', 'Pending Balance'].includes(key)) {
        td.textContent = formatter.format(value || 0);
      } else if (key === 'Date' && value) {
        const match = value.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/);
        if (match) {
          td.textContent = `${match[1].padStart(2, '0')}/${match[2].padStart(2, '0')}/${match[3]}`;
          td.dataset.sort = `${match[3]}-${match[2].padStart(2, '0')}-${match[1].padStart(2, '0')}`;
        } else {
          console.error(`Invalid date in ${tab} table: ${value}`);
          td.textContent = value || '';
        }
      } else {
        td.textContent = value || '';
      }
      tr.appendChild(td);
    });
    if (['customers', 'sales', 'payments'].includes(tab)) {
      const td = document.createElement('td');
      const idKey = tab === 'customers' ? 'Customer ID' : tab === 'sales' ? 'Sale ID' : 'Payment ID';
      const name = row[idKey];
      td.innerHTML = `<button class="btn btn-sm btn-outline-danger" onclick="delete${tab.charAt(0).toUpperCase() + tab.slice(1).replace('s', '')}('${row[idKey]}', '${name}')">Delete</button>`;
      tr.appendChild(td);
    }
    fragment.appendChild(tr);
  });
  tbody.innerHTML = '';
  tbody.appendChild(fragment);
  table.classList.remove('loaded');
  setTimeout(() => table.classList.add('loaded'), 50);
}

    function updateBadges(tab, data) {
      if (tab === 'customers') {
        const totalCustomers = document.getElementById('totalCustomers');
        if (totalCustomers) {
          totalCustomers.textContent = data.length;
        }
      } else if (tab === 'sales') {
        const totalSalesAmount = document.getElementById('totalSalesAmount');
        if (totalSalesAmount) {
          const totalSales = data.reduce((sum, row) => sum + (row.Amount || 0), 0);
          totalSalesAmount.textContent = formatter.format(totalSales);
        }
      } else if (tab === 'payments') {
        const totalPaymentsReceived = document.getElementById('totalPaymentsReceived');
        if (totalPaymentsReceived) {
          const totalPayments = data.reduce((sum, row) => sum + (row['Payment Received'] || 0), 0);
          totalPaymentsReceived.textContent = formatter.format(totalPayments);
        }
      }
    }

    function filterCustomers() {
      const search = document.getElementById('customerSearch')?.value.toLowerCase();
      const data = tableDataCache['customers'] || [];
      const filtered = data.filter(row => row.Name.toLowerCase().includes(search));
      renderTable('customers', filtered);
    }

    function filterSalesTable(startDate, endDate) {
      const salesData = tableDataCache['sales'] || [];
      const filtered = salesData.filter(row => {
        const match = row.Date?.match(/^(\d{2})[\/-](\d{2})[\/-](\d{4})$/);
        if (!match) return false;
        const date = new Date(parseInt(match[3]), parseInt(match[2]) - 1, parseInt(match[1]));
        return date >= startDate && date <= endDate;
      });
      renderTable('sales', filtered);
      updateBadges('sales', filtered);
    }

    function filterPayments() {
      const method = document.getElementById('paymentMethodFilter')?.value;
      const data = tableDataCache['payments'] || [];
      const filtered = method ? data.filter(row => row['Payment Method'] === method) : data;
      renderTable('payments', filtered);
      updateBadges('payments', filtered);
    }

    function populateTransactionCustomerFilter(data) {
      const select = document.getElementById('transactionCustomerFilter');
      if (!select) return;
      const customers = [...new Set(data.map(row => row.Customer))].sort();
      select.innerHTML = '<option value="">All Customers</option>';
      customers.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer;
        option.textContent = customer;
        select.appendChild(option);
      });
    }

    function filterTransactions() {
      const customer = document.getElementById('transactionCustomerFilter')?.value;
      const data = tableDataCache['transactions'] || [];
      const filtered = customer ? data.filter(row => row.Customer === customer) : data;
      renderTable('transactions', filtered);
    }

    function sortTable(tableId, column, isDate = false) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const th = table.querySelector(`th[data-column="${column}"]`);
      const isAscending = th.classList.contains('sort-asc');
      rows.sort((a, b) => {
        let aValue = isDate ? a.querySelector(`td[data-sort]`).dataset.sort : a.querySelector(`td:nth-child(${getColumnIndex(table, column)})`).textContent;
        let bValue = isDate ? b.querySelector(`td[data-sort]`).dataset.sort : b.querySelector(`td:nth-child(${getColumnIndex(table, column)})`).textContent;
        if (isDate) {
          return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
        } else {
          return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
        }
      });
      const fragment = document.createDocumentFragment();
      rows.forEach(row => fragment.appendChild(row));
      tbody.innerHTML = '';
      tbody.appendChild(fragment);
      table.querySelectorAll('th.sortable').forEach(h => {
        h.classList.remove('sort-asc', 'sort-desc');
        h.querySelector('i').className = 'bi bi-sort-down';
      });
      th.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
      th.querySelector('i').className = isAscending ? 'bi bi-sort-up' : 'bi bi-sort-down';
    }

    function getColumnIndex(table, column) {
      const headers = Array.from(table.querySelectorAll('thead th'));
      return headers.findIndex(th => th.dataset.column === column) + 1;
    }

    function populateCustomerDropdowns() {
      google.script.run
        .withSuccessHandler(data => {
          if (data && data.success) {
            ['saleCustomer', 'paymentCustomer'].forEach(id => {
              const select = document.getElementById(id);
              if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Customer</option>';
                data.data.forEach(customer => {
                  const option = document.createElement('option');
                  option.value = customer.Name;
                  option.textContent = customer.Name;
                  select.appendChild(option);
                });
                select.value = currentValue;
              }
            });
          } else {
            console.error('Failed to load customers for dropdowns:', data?.message);
            showSuccessToast(`Error loading customers: ${data?.message || 'Failed to load'}`);
          }
        })
        .withFailureHandler(err => {
          console.error('Error loading customers for dropdowns:', err);
          showSuccessToast(`Error loading customers: ${err.message || 'Unknown error'}`);
        })
        .getCustomers();
    }

    function addCustomer() {
      const nameEl = document.getElementById('customerName');
      const submitBtn = document.getElementById('submitCustomerBtn');
      const modal = document.getElementById('customerModal');
      const keepOpen = document.getElementById('keepCustomerOpen')?.checked;
      if (!nameEl || !modal) return;
      const name = nameEl.value.trim();
      if (!name) {
        showSuccessToast('Please enter a customer name.');
        return;
      }
      if (submitBtn && modal) {
        const spinner = submitBtn.querySelector('.spinner-border');
        if (spinner) spinner.classList.remove('d-none');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';
        modal.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
      }
      google.script.run
        .withSuccessHandler(result => {
          if (result && result.success) {
            showSuccessToast(result.message);
            if (!keepOpen) {
              const customerModal = bootstrap.Modal.getInstance(modal);
              if (customerModal) customerModal.hide();
              resetCustomerForm();
            } else {
              resetCustomerForm();
              modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
            }
            tableDataCache['customers'] = null;
            loadTableData('customers');
            populateCustomerDropdowns();
            loadTableData('dashboard');
          } else {
            showSuccessToast(`Error: ${result?.message || 'Failed to add customer'}`);
            if (submitBtn) {
              const spinner = submitBtn.querySelector('.spinner-border');
              if (spinner) spinner.classList.add('d-none');
              submitBtn.innerHTML = 'Submit';
            }
            if (modal) modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
          }
        })
        .withFailureHandler(err => {
          showSuccessToast(`Error: ${err.message || 'Unknown error'}`);
          if (submitBtn) {
            const spinner = submitBtn.querySelector('.spinner-border');
            if (spinner) spinner.classList.add('d-none');
            submitBtn.innerHTML = 'Submit';
          }
          if (modal) modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
        })
        .addCustomer({ name });
    }

    function validateDate(dateStr) {
      const formats = [
        /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/,
        /^(\d{4})-(\d{1,2})-(\d{1,2})$/
      ];
      for (const regex of formats) {
        const match = dateStr.match(regex);
        if (match) {
          let day, month, year;
          if (regex === formats[0]) {
            day = parseInt(match[1], 10);
            month = parseInt(match[2], 10);
            year = parseInt(match[3], 10);
          } else {
            year = parseInt(match[1], 10);
            month = parseInt(match[2], 10);
            day = parseInt(match[3], 10);
          }
          const date = new Date(year, month - 1, day);
          return !isNaN(date.getTime()) && date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day;
        }
      }
      return false;
    }

    function addSale() {
      const modal = document.getElementById('salesModal');
      const submitBtn = document.getElementById('submitSaleBtn');
      const keepOpen = document.getElementById('keepSalesOpen')?.checked;
      const dateInput = document.getElementById('saleDate')?.value;
      if (!validateDate(dateInput)) {
        showSuccessToast('Invalid date format. Use dd/mm/yyyy or yyyy-mm-dd.');
        return;
      }
      const match = dateInput.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/) || dateInput.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      const saleData = {
        date: match[0].includes('-') && match[0].length > 8 ? 
              `${match[3].padStart(2, '0')}/${match[2].padStart(2, '0')}/${match[1]}` : 
              `${match[1].padStart(2, '0')}/${match[2].padStart(2, '0')}/${match[3]}`,
        customer: document.getElementById('saleCustomer')?.value,
        quantity: parseFloat(document.getElementById('saleQuantity')?.value) || 0,
        rate: parseFloat(document.getElementById('saleRate')?.value) || 0,
        vehicleRent: parseFloat(document.getElementById('saleVehicleRent')?.value) || 0,
        amount: updateSaleAmount(),
        paymentMethod: document.getElementById('salePaymentMethod')?.value,
        paymentReceived: parseFloat(document.getElementById('salePaymentReceived')?.value) || 0,
        remarks: document.getElementById('saleRemarks')?.value
      };
      if (!saleData.date || !saleData.customer || !saleData.quantity || !saleData.rate) {
        showSuccessToast('Please fill all required fields.');
        return;
      }
      if (saleData.paymentMethod && saleData.paymentReceived <= 0) {
        showSuccessToast('Payment Received must be greater than 0 when a Payment Method is selected.');
        return;
      }
      if (submitBtn && modal) {
        const spinner = submitBtn.querySelector('.spinner-border');
        if (spinner) spinner.classList.remove('d-none');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';
        modal.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
      }
      google.script.run
        .withSuccessHandler(result => {
          if (result && result.success) {
            showSuccessToast(result.message);
            if (!keepOpen) {
              const salesModal = bootstrap.Modal.getInstance(modal);
              if (salesModal) salesModal.hide();
              resetSalesForm();
            } else {
              resetSalesForm();
              document.getElementById('saleDate').value = saleData.date;
              document.getElementById('saleCustomer').value = saleData.customer;
              modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
            }
            tableDataCache['sales'] = null;
            tableDataCache['transactions'] = null;
            tableDataCache['balances'] = null;
            loadTableData('sales');
            loadTableData('dashboard');
            loadTableData('transactions');
            loadTableData('balances');
            populateCustomerDropdowns();
          } else {
            showSuccessToast(`Error: ${result?.message || 'Failed to add sale'}`);
            if (submitBtn) {
              const spinner = submitBtn.querySelector('.spinner-border');
              if (spinner) spinner.classList.add('d-none');
              submitBtn.innerHTML = 'Submit';
            }
            if (modal) modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
          }
        })
        .withFailureHandler(err => {
          showSuccessToast(`Error: ${err.message || 'Unknown error'}`);
          if (submitBtn) {
            const spinner = submitBtn.querySelector('.spinner-border');
            if (spinner) spinner.classList.add('d-none');
            submitBtn.innerHTML = 'Submit';
          }
          if (modal) modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
        })
        .addSale(saleData);
    }

    function addPayment() {
      const modal = document.getElementById('paymentModal');
      const submitBtn = document.getElementById('submitPaymentBtn');
      const keepOpen = document.getElementById('keepPaymentOpen')?.checked;
      const dateInput = document.getElementById('paymentDate')?.value;
      if (!validateDate(dateInput)) {
        showSuccessToast('Invalid date format. Use dd/mm/yyyy or yyyy-mm-dd.');
        return;
      }
      const match = dateInput.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/) || dateInput.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
      const paymentData = {
        date: match[0].includes('-') && match[0].length > 8 ? 
              `${match[3].padStart(2, '0')}/${match[2].padStart(2, '0')}/${match[1]}` : 
              `${match[1].padStart(2, '0')}/${match[2].padStart(2, '0')}/${match[3]}`,
        customer: document.getElementById('paymentCustomer')?.value,
        paymentMethod: document.getElementById('paymentMethod')?.value,
        paymentReceived: parseFloat(document.getElementById('paymentReceived')?.value) || 0,
        remarks: document.getElementById('paymentRemarks')?.value
      };
      if (!paymentData.date || !paymentData.customer || !paymentData.paymentMethod || paymentData.paymentReceived <= 0) {
        showSuccessToast('Please fill all required fields and ensure Payment Received is greater than 0.');
        return;
      }
      if (submitBtn && modal) {
        const spinner = submitBtn.querySelector('.spinner-border');
        if (spinner) spinner.classList.remove('d-none');
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';
        modal.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
      }
      google.script.run
        .withSuccessHandler(result => {
          if (result && result.success) {
            showSuccessToast(result.message);
            if (!keepOpen) {
              const paymentModal = bootstrap.Modal.getInstance(modal);
              if (paymentModal) paymentModal.hide();
              resetPaymentForm();
            } else {
              resetPaymentForm();
              document.getElementById('paymentDate').value = paymentData.date;
              document.getElementById('paymentCustomer').value = paymentData.customer;
              modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
            }
            tableDataCache['payments'] = null;
            tableDataCache['transactions'] = null;
            tableDataCache['balances'] = null;
            loadTableData('payments');
            loadTableData('dashboard');
            loadTableData('transactions');
            loadTableData('balances');
          } else {
            showSuccessToast(`Error: ${result?.message || 'Failed to add payment'}`);
            if (submitBtn) {
              const spinner = submitBtn.querySelector('.spinner-border');
              if (spinner) spinner.classList.add('d-none');
              submitBtn.innerHTML = 'Submit';
            }
            if (modal) modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
          }
        })
        .withFailureHandler(err => {
          showSuccessToast(`Error: ${err.message || 'Unknown error'}`);
          if (submitBtn) {
            const spinner = submitBtn.querySelector('.spinner-border');
            if (spinner) spinner.classList.add('d-none');
            submitBtn.innerHTML = 'Submit';
          }
          if (modal) modal.querySelectorAll('input, select, button').forEach(el => el.disabled = false);
        })
        .addPayment(paymentData);
    }

    function deleteCustomer(id, name) {
      if (confirm(`Are you sure you want to delete customer "${name}" (ID: ${id})?`)) {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.success) {
              showSuccessToast(result.message);
              tableDataCache['customers'] = null;
              loadTableData('customers');
              loadTableData('dashboard');
              populateCustomerDropdowns();
            } else {
              showSuccessToast(`Error: ${result?.message || 'Failed to delete customer'}`);
            }
          })
          .withFailureHandler(err => {
            showSuccessToast(`Error: ${err.message || 'Unknown error'}`);
          })
          .deleteCustomer(id);
      }
    }

    function deleteSale(id, name) {
      if (confirm(`Are you sure you want to delete sale "${name}" (ID: ${id})?`)) {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.success) {
              showSuccessToast(result.message);
              tableDataCache['sales'] = null;
              tableDataCache['transactions'] = null;
              tableDataCache['balances'] = null;
              loadTableData('sales');
              loadTableData('dashboard');
              loadTableData('transactions');
              loadTableData('balances');
            } else {
              showSuccessToast(`Error: ${result?.message || 'Failed to delete sale'}`);
            }
          })
          .withFailureHandler(err => {
            showSuccessToast(`Error: ${err.message || 'Unknown error'}`);
          })
          .deleteSale(id);
      }
    }

    function deletePayment(id, name) {
      if (confirm(`Are you sure you want to delete payment "${name}" (ID: ${id})?`)) {
        google.script.run
          .withSuccessHandler(result => {
            if (result && result.success) {
              showSuccessToast(result.message);
              tableDataCache['payments'] = null;
              tableDataCache['transactions'] = null;
              tableDataCache['balances'] = null;
              loadTableData('payments');
              loadTableData('dashboard');
              loadTableData('transactions');
              loadTableData('balances');
            } else {
              showSuccessToast(`Error: ${result?.message || 'Failed to delete payment'}`);
            }
          })
          .withFailureHandler(err => {
            showSuccessToast(`Error: ${err.message || 'Unknown error'}`);
          })
          .deletePayment(id);
      }
    }

    function togglePaymentReceived(methodId, receivedId) {
      const method = document.getElementById(methodId);
      const received = document.getElementById(receivedId);
      if (method && received) {
        const hasMethod = method.value !== '';
        received.disabled = !hasMethod;
        if (!hasMethod) {
          received.value = '0';
        }
        if (hasMethod && receivedId === 'paymentReceived') {
          received.required = true;
        } else {
          received.required = false;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      initializeFlatpickr();
      formatCurrencyInputs();
      setupTabNavigation();
      loadTableData('dashboard');
      populateCustomerDropdowns();

      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }

      const saleInputs = ['saleQuantity', 'saleRate', 'saleVehicleRent'];
      saleInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', updateSaleAmount);
        }
      });

      const customerSearch = document.getElementById('customerSearch');
      if (customerSearch) {
        customerSearch.addEventListener('input', filterCustomers);
      }

      const paymentMethodFilter = document.getElementById('paymentMethodFilter');
      if (paymentMethodFilter) {
        paymentMethodFilter.addEventListener('change', filterPayments);
      }

      const transactionCustomerFilter = document.getElementById('transactionCustomerFilter');
      if (transactionCustomerFilter) {
        transactionCustomerFilter.addEventListener('change', filterTransactions);
      }

      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.dataset.column;
          const tableId = th.closest('table').id;
          const isDate = column === 'Date';
          sortTable(tableId, column, isDate);
        });
      });

      const salePaymentMethod = document.getElementById('salePaymentMethod');
      if (salePaymentMethod) {
        salePaymentMethod.addEventListener('change', () => togglePaymentReceived('salePaymentMethod', 'salePaymentReceived'));
      }

      const paymentMethod = document.getElementById('paymentMethod');
      if (paymentMethod) {
        paymentMethod.addEventListener('change', () => togglePaymentReceived('paymentMethod', 'paymentReceived'));
      }
    });
  </script>
</body>
</html>
